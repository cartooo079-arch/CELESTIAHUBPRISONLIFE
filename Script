-- CELESTIA HUB v8.1 - PRISON LIFE - CLEAN VERSION
repeat task.wait() until game:IsLoaded() and game.Players.LocalPlayer and game.Players.LocalPlayer:FindFirstChild("PlayerGui")

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local player = Players.LocalPlayer
local playerGui = player.PlayerGui

if game.PlaceId ~= 155615604 then
    warn("Wrong game!")
    return
end

local character = player.Character or player.CharacterAdded:Wait()
local rootPart = character:WaitForChild("HumanoidRootPart")

-- === STATE ===
local FlyEnabled, FlySpeed, FlyBV = false, 60, nil
local ESP_Enabled, ESP_Loop, ESP_Objects = false, nil, {}
local AutoArrest_Enabled, ArrestLoop = false, nil

-- === DELAY ===
local function delay() task.wait(0.2 + math.random()*0.4) end
local function fire(r, ...) pcall(function() r:FireServer(...) end) delay() end

-- === GUI ===
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "CelestiaHub"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 400, 0, 450)
mainFrame.Position = UDim2.new(0.5, -200, 0.5, -225)
mainFrame.BackgroundColor3 = Color3.fromRGB(250,248,255)
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0,12)

-- Title
local title = Instance.new("Frame")
title.Size = UDim2.new(1,0,0,50)
title.BackgroundColor3 = Color3.fromRGB(180,140,255)
title.Parent = mainFrame
Instance.new("UICorner", title).CornerRadius = UDim.new(0,12)

local label = Instance.new("TextLabel")
label.Text = "Celestia Hub v8.1"
label.Size = UDim2.new(1,-60,1,0)
label.Position = UDim2.new(0,15,0,0)
label.BackgroundTransparency = 1
label.TextColor3 = Color3.new(1,1,1)
label.Font = Enum.Font.GothamBold
label.TextSize = 20
label.TextXAlignment = Enum.TextXAlignment.Left
label.Parent = title

-- Close
local close = Instance.new("TextButton")
close.Text = "×"
close.Size = UDim2.new(0,30,1,0)
close.Position = UDim2.new(1,-35,0,0)
close.BackgroundTransparency = 1
close.TextColor3 = Color3.new(1,1,1)
close.Font = Enum.Font.GothamBold
close.TextSize = 24
close.Parent = title
close.MouseButton1Click:Connect(function()
    screenGui:Destroy()
end)

-- === TABS ===
local tabFrame = Instance.new("Frame")
tabFrame.Size = UDim2.new(1,0,0,40)
tabFrame.Position = UDim2.new(0,0,0,50)
tabFrame.BackgroundColor3 = Color3.fromRGB(240,235,255)
tabFrame.Parent = mainFrame

local scroll = Instance.new("ScrollingFrame")
scroll.Size = UDim2.new(1,-20,1,-110)
scroll.Position = UDim2.new(0,10,0,95)
scroll.BackgroundTransparency = 1
scroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
scroll.Parent = mainFrame

local Tabs = {}
local function makeTab(name)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0,100,1,0)
    btn.Text = name
    btn.BackgroundColor3 = Color3.fromRGB(240,235,255)
    btn.TextColor3 = Color3.fromRGB(70,70,70)
    btn.Font = Enum.Font.GothamBold
    btn.Parent = tabFrame
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,8)

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1,0,0,0)
    frame.BackgroundTransparency = 1
    frame.Visible = name == "Main"
    frame.Parent = scroll

    btn.MouseButton1Click:Connect(function()
        for n, t in Tabs do
            t.frame.Visible = n == name
            t.btn.BackgroundColor3 = n == name and Color3.fromRGB(180,140,255) or Color3.fromRGB(240,235,255)
            t.btn.TextColor3 = n == name and Color3.new(1,1,1) or Color3.fromRGB(70,70,70)
        end
    end)

    Tabs[name] = {btn=btn, frame=frame}
    return frame
end

local mainTab = makeTab("Main")
local extraTab = makeTab("Extra")

-- === TOGGLE ===
local function toggle(parent, name, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1,0,0,40)
    frame.BackgroundColor3 = Color3.fromRGB(245,240,255)
    frame.Parent = parent
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0,10)

    local label = Instance.new("TextLabel")
    label.Text = name
    label.Size = UDim2.new(1,-60,1,0)
    label.Position = UDim2.new(0,12,0,0)
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(70,70,70)
    label.Font = Enum.Font.Gotham
    label.Parent = frame

    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0,42,0,20)
    btn.Position = UDim2.new(1,-52,0.5,-10)
    btn.BackgroundColor3 = Color3.fromRGB(180,140,255)
    btn.Text = "OFF"
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Parent = frame
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,8)

    local state = false
    btn.MouseButton1Click:Connect(function()
        state = not state
        btn.Text = state and "ON" or "OFF"
        btn.BackgroundColor3 = state and Color3.fromRGB(200,160,255) or Color3.fromRGB(180,140,255)
        callback(state)
    end)
end

-- === FLY ===
toggle(mainTab, "Fly", function(state)
    FlyEnabled = state
    if state then
        FlyBV = Instance.new("BodyVelocity")
        FlyBV.MaxForce = Vector3.new(1e5,1e5,1e5)
        FlyBV.Parent = rootPart
        task.spawn(function()
            while FlyEnabled do
                local cam = Workspace.CurrentCamera
                local dir = Vector3.new()
                if UserInputService:IsKeyDown(Enum.KeyCode.W) then dir += cam.CFrame.LookVector end
                if UserInputService:IsKeyDown(Enum.KeyCode.S) then dir -= cam.CFrame.LookVector end
                if UserInputService:IsKeyDown(Enum.KeyCode.A) then dir -= cam.CFrame.RightVector end
                if UserInputService:IsKeyDown(Enum.KeyCode.D) then dir += cam.CFrame.RightVector end
                if UserInputService:IsKeyDown(Enum.KeyCode.Space) then dir += Vector3.new(0,1,0) end
                if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then dir -= Vector3.new(0,1,0) end
                FlyBV.Velocity = dir.Magnitude > 0 and dir.unit * FlySpeed or Vector3.new()
                task.wait()
            end
        end)
    else
        if FlyBV then FlyBV:Destroy() end
    end
end)

-- === ESP ===
toggle(extraTab, "ESP", function(state)
    ESP_Enabled = state
    if state then
        ESP_Loop = RunService.RenderStepped:Connect(function()
            for _, p in Players:GetPlayers() do
                if p ~= player and p.Character and p.Character:FindFirstChild("Head") then
                    local head = p.Character.Head
                    local hrp = p.Character:FindFirstChild("HumanoidRootPart")
                    if hrp then
                        local sp, on = Workspace.CurrentCamera:WorldToViewportPoint(head.Position)
                        if on then
                            local dist = math.floor((hrp.Position - rootPart.Position).Magnitude)
                            local box = ESP_Objects[p] or Drawing.new("Square")
                            local name = ESP_Objects[p] and ESP_Objects[p].name or Drawing.new("Text")

                            local size = (300 / sp.Z) * 2
                            box.Size = Vector2.new(size, size*1.8)
                            box.Position = Vector2.new(sp.X - size/2, sp.Y - size*0.9)
                            box.Thickness = 2; box.Color = Color3.new(1,0,0); box.Filled = false; box.Visible = true

                            name.Text = p.Name.." ["..dist.."m]"
                            name.Position = Vector2.new(sp.X, sp.Y - size*0.9 - 20)
                            name.Size = 16; name.Center = true; name.Outline = true; name.Color = Color3.new(1,1,1); name.Visible = true

                            ESP_Objects[p] = {box=box, name=name}
                        end
                    end
                end
            end
        end)
    else
        if ESP_Loop then ESP_Loop:Disconnect() end
        for _, v in ESP_Objects do pcall(function() v.box:Remove() v.name:Remove() end) end
        ESP_Objects = {}
    end
end)

print("CELESTIA HUB LOADED – GUI VISIBLE")
