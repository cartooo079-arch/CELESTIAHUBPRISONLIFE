-- Straw Universal - FINAL (Starts Visible + H to Hide)
-- Fly + ESP + Speed + Random TP | Universal
-- FIXED for anti-cheat: Slower fly, limited speed, gradual TP

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")

-- GUI
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local CloseButton = Instance.new("TextButton")
local FlyToggle = Instance.new("TextButton")
local ESPToggle = Instance.new("TextButton")
local SpeedLabel = Instance.new("TextLabel")
local SpeedBox = Instance.new("TextBox")
local RandomTPButton = Instance.new("TextButton")

ScreenGui.Parent = game.CoreGui
ScreenGui.Name = "StrawUniversal"
ScreenGui.ResetOnSpawn = false

-- Main Frame
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
MainFrame.BorderSizePixel = 0
MainFrame.Position = UDim2.new(0.35, 0, 0.3, 0)
MainFrame.Size = UDim2.new(0, 300, 0, 240)
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Visible = true  -- NOW VISIBLE ON START

local Corner = Instance.new("UICorner")
Corner.CornerRadius = UDim.new(0, 12)
Corner.Parent = MainFrame

local Stroke = Instance.new("UIStroke")
Stroke.Color = Color3.fromRGB(100, 150, 255)
Stroke.Thickness = 1.8
Stroke.Parent = MainFrame

-- Title (Updated)
Title.Parent = MainFrame
Title.BackgroundTransparency = 1
Title.Size = UDim2.new(1, -40, 0, 40)
Title.Position = UDim2.new(0, 20, 0, 10)
Title.Text = "Straw Universal â€“ Press H to Hide"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 16
Title.TextXAlignment = Enum.TextXAlignment.Left

-- Close Button
CloseButton.Parent = MainFrame
CloseButton.BackgroundTransparency = 1
CloseButton.Size = UDim2.new(0, 30, 0, 30)
CloseButton.Position = UDim2.new(1, -40, 0, 10)
CloseButton.Text = "X"
CloseButton.TextColor3 = Color3.fromRGB(255, 100, 100)
CloseButton.Font = Enum.Font.GothamBold
CloseButton.TextSize = 20
CloseButton.MouseButton1Click:Connect(function() MainFrame.Visible = false end)

-- Fly Toggle
FlyToggle.Parent = MainFrame
FlyToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
FlyToggle.Size = UDim2.new(1, -40, 0, 35)
FlyToggle.Position = UDim2.new(0, 20, 0, 55)
FlyToggle.Text = "Fly: OFF"
FlyToggle.TextColor3 = Color3.fromRGB(255, 100, 100)
FlyToggle.Font = Enum.Font.GothamBold
FlyToggle.TextSize = 14

local fCorner = Instance.new("UICorner")
fCorner.CornerRadius = UDim.new(0, 8)
fCorner.Parent = FlyToggle

-- ESP Toggle
ESPToggle.Parent = MainFrame
ESPToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
ESPToggle.Size = UDim2.new(1, -40, 0, 35)
ESPToggle.Position = UDim2.new(0, 20, 0, 95)
ESPToggle.Text = "ESP: OFF"
ESPToggle.TextColor3 = Color3.fromRGB(255, 100, 100)
ESPToggle.Font = Enum.Font.GothamBold
ESPToggle.TextSize = 14

local eCorner = Instance.new("UICorner")
eCorner.CornerRadius = UDim.new(0, 8)
eCorner.Parent = ESPToggle

-- Speed
SpeedLabel.Parent = MainFrame
SpeedLabel.BackgroundTransparency = 1
SpeedLabel.Size = UDim2.new(1, -40, 0, 25)
SpeedLabel.Position = UDim2.new(0, 20, 0, 135)
SpeedLabel.Text = "WalkSpeed:"
SpeedLabel.TextColor3 = Color3.fromRGB(220, 220, 220)
SpeedLabel.Font = Enum.Font.Gotham
SpeedLabel.TextSize = 13

SpeedBox.Parent = MainFrame
SpeedBox.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
SpeedBox.Size = UDim2.new(1, -40, 0, 30)
SpeedBox.Position = UDim2.new(0, 20, 0, 160)
SpeedBox.PlaceholderText = "1 - 50"
SpeedBox.Text = "16"
SpeedBox.TextColor3 = Color3.fromRGB(255, 255, 255)
SpeedBox.Font = Enum.Font.Gotham
SpeedBox.TextSize = 14

local sCorner = Instance.new("UICorner")
sCorner.CornerRadius = UDim.new(0, 8)
sCorner.Parent = SpeedBox

-- Random TP Button
RandomTPButton.Parent = MainFrame
RandomTPButton.BackgroundColor3 = Color3.fromRGB(100, 50, 150)
RandomTPButton.Size = UDim2.new(1, -40, 0, 35)
RandomTPButton.Position = UDim2.new(0, 20, 1, -55)
RandomTPButton.Text = "Teleport to Random"
RandomTPButton.TextColor3 = Color3.fromRGB(255, 255, 255)
RandomTPButton.Font = Enum.Font.GothamBold
RandomTPButton.TextSize = 14

local tpCorner = Instance.new("UICorner")
tpCorner.CornerRadius = UDim.new(0, 8)
tpCorner.Parent = RandomTPButton

-- Variables
local isFlying = false
local espEnabled = false
local currentSpeed = 16
local bodyPosition, bodyGyro
local espObjects = {}

-- === FLY SYSTEM (FIXED: Slower speed, BodyPosition instead of Velocity for smoother replication) ===
local function startFly()
    if isFlying then return end
    isFlying = true
    FlyToggle.Text = "Fly: ON"
    FlyToggle.TextColor3 = Color3.fromRGB(100, 255, 100)
    FlyToggle.BackgroundColor3 = Color3.fromRGB(40, 80, 40)

    local cam = workspace.CurrentCamera
    bodyGyro = Instance.new("BodyGyro")
    bodyPosition = Instance.new("BodyPosition")  -- Changed to BodyPosition for better anti-cheat evasion
    bodyGyro.P = 9000
    bodyGyro.MaxTorque = Vector3.new(400000, 400000, 400000)
    bodyGyro.Parent = rootPart
    bodyPosition.MaxForce = Vector3.new(400000, 400000, 400000)
    bodyPosition.Position = rootPart.Position
    bodyPosition.Parent = rootPart

    spawn(function()
        while isFlying and rootPart.Parent do
            local dir = Vector3.new(0,0,0)
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then dir += cam.CFrame.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then dir -= cam.CFrame.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then dir -= cam.CFrame.RightVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then dir += cam.CFrame.RightVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.Space) then dir += Vector3.new(0,1,0) end
            if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then dir -= Vector3.new(0,1,0) end
            bodyPosition.Position = bodyPosition.Position + (dir * 16)  -- Slower speed: 16 studs/sec to mimic walk speed
            bodyGyro.CFrame = cam.CFrame
            RunService.Heartbeat:Wait()
        end
    end)
end

local function stopFly()
    isFlying = false
    FlyToggle.Text = "Fly: OFF"
    FlyToggle.TextColor3 = Color3.fromRGB(255, 100, 100)
    FlyToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
    if bodyGyro then bodyGyro:Destroy() end
    if bodyPosition then bodyPosition:Destroy() end
end

FlyToggle.MouseButton1Click:Connect(function()
    if isFlying then stopFly() else startFly() end
end)

-- === ESP SYSTEM (Unchanged, as ESP is client-side and shouldn't trigger kicks) ===
local function isEnemy(p)
    return not p.Team or not player.Team or p.Team ~= player.Team
end

local function createESP(p)
    if p == player or not p.Character then return end
    local char = p.Character
    local head = char:FindFirstChild("Head")
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not head or not hrp then return end

    local box = Instance.new("BoxHandleAdornment")
    box.Adornee = char
    box.Size = char:GetExtentsSize() + Vector3.new(0.3, 0.3, 0.3)
    box.Color3 = isEnemy(p) and Color3.fromRGB(255, 0, 100) or Color3.fromRGB(0, 255, 100)
    box.Transparency = 0.6
    box.AlwaysOnTop = true
    box.Parent = char

    local billboard = Instance.new("BillboardGui")
    billboard.Adornee = head
    billboard.Size = UDim2.new(0, 100, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = head

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = p.DisplayName
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextStrokeTransparency = 0
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.Parent = billboard

    espObjects[p] = {box, billboard}
end

local function toggleESP()
    espEnabled = not espEnabled
    ESPToggle.Text = "ESP: " .. (espEnabled and "ON" or "OFF")
    ESPToggle.TextColor3 = espEnabled and Color3.fromRGB(100, 255, 100) or Color3.fromRGB(255, 100, 100)
    ESPToggle.BackgroundColor3 = espEnabled and Color3.fromRGB(40, 80, 40) or Color3.fromRGB(60, 60, 70)

    if espEnabled then
        for _, p in Players:GetPlayers() do createESP(p) end
        Players.PlayerAdded:Connect(function(p) p.CharacterAdded:Connect(function() createESP(p) end) end)
    else
        for _, objs in espObjects do for _, o in objs do o:Destroy() end end
        espObjects = {}
    end
end

ESPToggle.MouseButton1Click:Connect(toggleESP)

-- === SET SPEED (FIXED: Limited to 50 max to avoid detection) ===
local function setSpeed(speed)
    speed = tonumber(speed)
    if speed and speed >= 1 and speed <= 50 then  -- Reduced max to 50
        currentSpeed = speed
        humanoid.WalkSpeed = speed
        SpeedBox.Text = tostring(speed)
    else
        SpeedBox.Text = tostring(currentSpeed)
    end
end

SpeedBox.FocusLost:Connect(function(enter)
    if enter then setSpeed(SpeedBox.Text) end
end)

SpeedBox:GetPropertyChangedSignal("Text"):Connect(function()
    SpeedBox.Text = SpeedBox.Text:gsub("[^%d]", "")
end)

setSpeed(16)

-- === RANDOM TELEPORT (FIXED: Gradual tween over 1 second to simulate walking) ===
local function randomTeleport()
    local map = workspace
    local validParts = {}
    for _, part in pairs(map:GetDescendants()) do
        if part:IsA("BasePart") and part.Size.Magnitude > 10 and part.CanCollide then
            table.insert(validParts, part)
        end
    end
    if #validParts == 0 then return end

    local target = validParts[math.random(1, #validParts)]
    local pos = target.Position + Vector3.new(0, target.Size.Y/2 + 5, 0)
    
    -- Tween to position gradually over 1 second
    local tween = TweenService:Create(rootPart, TweenInfo.new(1, Enum.EasingStyle.Linear), {CFrame = CFrame.new(pos)})
    tween:Play()
    
    RandomTPButton.Text = "Teleported!"
    tween.Completed:Connect(function()
        task.wait(0.8)
        RandomTPButton.Text = "Teleport to Random"
    end)
end

RandomTPButton.MouseButton1Click:Connect(randomTeleport)

-- === HOTKEY: H = TOGGLE GUI (NOW WITH GAME PROCESSED CHECK) ===
UserInputService.InputBegan:Connect(function(key, gameProcessed)
    if gameProcessed then return end
    if key.KeyCode == Enum.KeyCode.H then
        MainFrame.Visible = not MainFrame.Visible
    end
end)

-- === RESPAWN HANDLER ===
player.CharacterAdded:Connect(function(newChar)
    character = newChar
    humanoid = character:WaitForChild("Humanoid")
    rootPart = character:WaitForChild("HumanoidRootPart")
    humanoid.WalkSpeed = currentSpeed
    if isFlying then task.wait(0.5); startFly() end
end)

-- === HOVER EFFECTS ===
local function hover(btn, on, off)
    btn.MouseEnter:Connect(function() TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = on}):Play() end)
    btn.MouseLeave:Connect(function() TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = off}):Play() end)
end

hover(FlyToggle, Color3.fromRGB(80,80,90), Color3.fromRGB(60,60,70))
hover(ESPToggle, Color3.fromRGB(80,80,90), Color3.fromRGB(60,60,70))
hover(RandomTPButton, Color3.fromRGB(130,70,180), Color3.fromRGB(100,50,150))

print("Straw Universal LOADED! GUI is visible. Press H to hide/show. (Anti-kick fixes applied)")
